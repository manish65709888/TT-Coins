<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Get Coins">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>TikTok Recharge</title>
<link rel="icon" type="image/png" href="tiktok.png">
<link rel="apple-touch-icon" href="tiktok.png">
<link rel="manifest" href="/manifest.json">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
        background-color: #f8f8f8;
        height: 100vh;
        display: flex;
        flex-direction: column;
        max-width: 400px;
        margin: 0 auto;
        position: relative;
        overflow-x: hidden;
    }

    .header {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background-color: white;
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 1px solid #e8e8e8;
    }

    .header h1 {
        flex: 1;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
    }

    .back-button {
        font-size: 24px;
        cursor: pointer;
    }

    .main-content {
        padding: 16px;
        flex: 1;
        background-color: white;
        overflow-y: auto;
    }

    /* Your existing styles remain the same */
    .profile-section {
        background-color: white;
        padding: 12px 16px;
        margin-bottom: 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        position: relative;
    }

    .profile-pic {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background-color: #f1f1f2;
        overflow: hidden;
        margin-right: 12px;
    }

    .profile-info {
        flex: 1;
    }

    .username {
        font-size: 16px;
        font-weight: 500;
    }

    .coins-count {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #888;
    }

    .dropdown-arrow {
        position: absolute;
        right: 16px;
        font-size: 20px;
        color: #888;
    }

    .recharge-label {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .save-notice {
        color: #ff3b5c;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        font-size: 14px;
    }

    .info-icon {
        margin-left: 5px;
        border: 1px solid #544d4e;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #544d4e;
        cursor: pointer;
    }

    .coin-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }

    .coin-option {
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
    }

    .coin-option.selected {
        border: 2px solid #ffcc00;
    }

    .coin-option.custom {
        justify-content: center;
    }

    .coin-amount {
        display: flex;
        align-items: center;
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 4px;
    }

    .coin-icon {
        width: 20px;
        height: 20px;
        background-color: #ffcc00;
        border-radius: 50%;
        margin-right: 4px;
    }

    .coin-price {
        color: #888;
        font-size: 14px;
    }

    .custom-text {
        font-weight: 600;
    }

    .custom-subtext {
        color: #888;
        font-size: 12px;
    }

    .payment-methods {
        display: flex;
        margin-bottom: 20px;
        font-size: 14px;
        color: #555;
    }

    .payment-icon {
        margin-right: 5px;
    }

    .total-section {
        display: flex;
        justify-content: space-between;
        font-size: 16px;
        padding-bottom: 10px;
        border-top: 1px solid #e8e8e8;
        padding-top: 10px;
    }

    .total-price {
        font-weight: 600;
    }

    .footer {
        display: flex;
        justify-content: space-between;
        padding: 12px 16px;
        background-color: white;
        border-top: 1px solid #e8e8e8;
    }

    .recharge-button {
        width: 100%;
        background-color: #ff3b5c;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
    }

    /* Modal styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: white;
        border-radius: 12px;
        width: 90%;
        max-width: 350px;
        padding: 20px;
        position: relative;
    }

    .slide-up {
        animation: slideUp 0.3s ease-out;
        transform-origin: bottom center;
    }

    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Fix for the countdown timer */
    #countdown {
        font-size: 18px;
        font-weight: bold;
        margin-top: 10px;
    }

    .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        cursor: pointer;
    }

    .modal-header {
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .custom-input-section {
        margin-bottom: 20px;
    }

    .input-label {
        font-size: 14px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }

    .dropdown-icon {
        margin-left: 5px;
    }

    .custom-coin-input {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    .keypad {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }

    .key {
        background-color: #f1f1f2;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-size: 16px;
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        color: #000;
    }

    .key:focus,
    .key:active,
    .key:hover {
        background-color: #e5e5e5;
        color: #000;
        outline: none;
        -webkit-tap-highlight-color: transparent;
    }

    button {
        color: inherit;
        -webkit-tap-highlight-color: transparent;
    }

    /* Order summary modal */
    .order-summary {
        text-align: left;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .summary-label {
        color: #888;
    }

    .payment-method {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    .card-info {
        margin-left: 10px;
    }

    .terms-text {
        font-size: 12px;
        color: #888;
        margin-bottom: 20px;
        line-height: 1.4;
    }

    .terms-link {
        font-weight: 600;
        color: black;
        text-decoration: none;
    }

    #customModal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: none;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 0;
    }

    #customModal .modal-content {
        width: 100%;
        max-width: 100%;
        border-radius: 12px 12px 0 0;
        position: relative;
        margin-bottom: 0;
        margin-left: 0;
        margin-right: 0;
    }

    @media (min-width: 768px) {
        #customModal .modal-content {
            width: 400px;
            max-width: 400px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        #customModal {
            padding-bottom: 20px;
        }
    }

    /* Processing and success modals */
    .processing-payment,
    .payment-success {
        text-align: center;
    }

    .loader {
        position: relative;
        width: 80px;
        height: 50px;
        margin: 0 auto 20px;
    }

    .tiktok {
        position: absolute;
        width: 50px;
        height: 50px;
        background: rgb(77, 232, 244);
        border-radius: 50%;
        animation: leftToRight 0.8s ease-in-out infinite;
        mix-blend-mode: darken;
        transform: scale(1);
    }

    .tiktok.red {
        background: rgb(253, 62, 62);
        animation: rightToLeft 0.8s ease-in-out infinite;
    }

    @keyframes leftToRight {
        0% {
            left: 0;
        }
        25% {
            transform: scale(1.2);
        }
        50% {
            left: 30px;
        }
        75% {
            transform: scale(0.8);
        }
        100% {
            left: 0;
        }
    }

    @keyframes rightToLeft {
        0% {
            right: 0;
        }
        25% {
            transform: scale(0.8);
        }
        50% {
            right: 30px;
        }
        75% {
            transform: scale(1.2);
        }
        100% {
            right: 0;
        }
    }

    .processing-text {
        margin-bottom: 5px;
        font-weight: 600;
    }

    .timer {
        color: #888;
        margin-bottom: 20px;
    }

    .success-icon {
        width: 60px;
        height: 60px;
        background-color: #52cc52;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 32px;
    }

    .success-title {
        font-weight: 600;
        margin-bottom: 10px;
    }

    .success-message {
        color: #888;
        margin-bottom: 20px;
    }

    .go-back-button {
        background-color: #ff3b5c;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px 24px;
        font-size: 16px;
        cursor: pointer;
    }

    .username-textbox {
        padding: 8px;
        background-color: #f5f5f5;
        font-family: Arial, sans-serif;
        margin-bottom: 3px;
    }

    .username-textbox p {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }

    .username-input {
        background-color: #f5f5f5;
        border: none;
        padding: 10px 0;
        width: 100%;
        color: #0c0303;
        font-size: 16px;
        outline: none;
    }

    /* TikTok Profile Lookup */
    .profile-lookup {
        background-color: white;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        display: none;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .profile-lookup.show {
        display: flex;
    }

    .profile-lookup-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
    }

    .profile-lookup-info {
        flex: 1;
    }

    .profile-lookup-handle {
        font-size: 14px;
        font-weight: 600;
        color: #000;
        margin-bottom: 2px;
    }

    .profile-lookup-nickname {
        font-size: 12px;
        color: #666;
        margin-bottom: 2px;
    }

    .profile-lookup-followers {
        font-size: 12px;
        color: #888;
    }

    #customAmount {
        background-color: #f5f5f5;
        border: none;
        padding: 10px 0;
        color: #0c0303;
        font-size: 16px;
        outline: none;
        display: inline-block;
    }

    .custom-coin-input {
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: #f5f5f5;
    }

    /* Error prevention styles */
    .error-prevention {
        display: none;
    }
</style>
</head>

<body>
<!-- Main page -->
<div class="header">
    <div class="back-button" onclick="logoutAndGoBack()">←</div>
    <h1>Get Coins</h1>
</div>

<div class="main-content">
    <!-- Updated profile section -->
    <div class="profile-section">
        <div class="profile-pic">
            <img src="tiktok.png" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <div class="profile-info">
            <div class="username">Recharge</div>
            <div class="coins-count">
                <img src="moneda2.png" style="width: 16px; height: 16px; margin-right: 4px;"> 0
            </div>
        </div>
        <div class="dropdown-arrow">▼</div>
    </div>

    <div class="username-textbox">
        <input type="text" id="usernameInput" class="username-input" placeholder="Username">
    </div>

    <!-- TikTok Profile Lookup -->
    <div id="profileLookup" class="profile-lookup">
        <img id="profileAvatar" class="profile-lookup-avatar" src="" alt="Profile">
        <div class="profile-lookup-info">
            <div id="profileHandle" class="profile-lookup-handle"></div>
            <div id="profileNickname" class="profile-lookup-nickname"></div>
            <div id="profileFollowers" class="profile-lookup-followers"></div>
        </div>
    </div>

    <div class="recharge-label">Recharge:</div>
    <div class="save-notice">
        Save around 25% with a lower third-party service fee
        <div class="info-icon">i</div>
    </div>

    <div class="coin-grid">
        <div class="coin-option" data-coins="70" data-price="0.74" onclick="selectCoinOption(this)">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> 70
            </div>
            <div class="coin-price">$ 0.74</div>
        </div>

        <div class="coin-option" data-coins="350" data-price="3.7" onclick="selectCoinOption(this)">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> 350
            </div>
            <div class="coin-price">$ 3.7</div>
        </div>

        <div class="coin-option" data-coins="700" data-price="7.4" onclick="selectCoinOption(this)">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> 700
            </div>
            <div class="coin-price">$ 7.4</div>
        </div>

        <div class="coin-option" data-coins="1400" data-price="14.8" onclick="selectCoinOption(this)">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> 1,400
            </div>
            <div class="coin-price">$ 14.8</div>
        </div>

        <div class="coin-option" data-coins="3500" data-price="37" onclick="selectCoinOption(this)">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> 3,500
            </div>
            <div class="coin-price">$ 37</div>
        </div>

        <div class="coin-option" data-coins="7000" data-price="74" onclick="selectCoinOption(this)">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> 7,000
            </div>
            <div class="coin-price">$ 74</div>
        </div>

        <div class="coin-option" data-coins="17500" data-price="185" onclick="selectCoinOption(this)">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> 17,500
            </div>
            <div class="coin-price">$ 185</div>
        </div>

        <div class="coin-option custom" data-coins="custom" onclick="openCustomModal()">
            <div class="coin-amount">
                <img src="moneda2.png" style="width: 28px; height: 28px;"> Custom
            </div>
            <div class="custom-subtext">Large amount supported</div>
        </div>
    </div>

    <div class="payment-methods">
        <img src="images.png" style="width: 28px; height: 28px; margin-right: 10px;">
        <img src="images (1).png" style="width: 20px; height: 20px; margin-right: 10px; margin-top: 5px;">
        <img src="American_Express_logo.png" style="width: 20px; height: 20px; margin-right: 10px; margin-top: 5px;">
        <img src="images.jpeg" style="width: 20px; height: 20px; margin-right: 10px; margin-top: 5px;">

        <img src="png.png" style="width: 20px; height: 20px; margin-right: 10px; margin-top: 5px;">
        <img src="Maestro-logo.png" style="width: 20px; height: 20px; margin-right: 10px; margin-top: 5px;">
        <img src="paypal.png" style="width: 20px; height: 30px; margin-bottom: 3px;">
    </div>

    <div class="total-section">
        <div class="total-label">Total</div>
        <div class="total-price">$ 74</div>
    </div>
</div>

<div class="footer">
    <button class="recharge-button" onclick="openOrderSummaryModal()">Recharge</button>
</div>

<!-- Custom amount modal -->
<div class="modal" id="customModal">
    <div class="modal-content slide-up">
        <div class="close-button" onclick="closeModal('customModal')">×</div>
        <div class="modal-header">Custom</div>

        <div class="custom-input-section">
            <div class="input-label">
                Number of Coins <span class="dropdown-icon">▼</span>
            </div>
            <div class="custom-coin-input">
                <img src="moneda2.png" style="width: 28px; height: 28px;">
                <span id="customAmount">99999</span>
            </div>
        </div>

        <div class="keypad">
            <button class="key" onclick="addDigit(1)">1</button>
            <button class="key" onclick="addDigit(2)">2</button>
            <button class="key" onclick="addDigit(3)">3</button>
            <button class="key" onclick="deleteDigit()">⌫</button>
            <button class="key" onclick="addDigit(4)">4</button>
            <button class="key" onclick="addDigit(5)">5</button>
            <button class="key" onclick="addDigit(6)">6</button>
            <button class="key" onclick="addDigit('000')">000</button>
            <button class="key" onclick="addDigit(7)">7</button>
            <button class="key" onclick="addDigit(8)">8</button>
            <button class="key" onclick="addDigit(9)">9</button>
            <button class="key" onclick="addDigit(0)">0</button>
        </div>

        <div class="total-section">
            <div class="total-label">Total</div>
            <div class="total-price">$</div>
        </div>

        <button class="recharge-button" onclick="confirmCustomAmount()">Recharge</button>
    </div>
</div>

<!-- Order summary modal -->
<div class="modal" id="orderSummaryModal">
    <div class="modal-content slide-up">
        <div class="close-button" onclick="closeModal('orderSummaryModal')">×</div>
        <div class="modal-header">Order summary</div>

        <div class="order-summary">
            <div class="summary-row">
                <div class="summary-label">Account</div>
                <div id="orderUsername"></div>
            </div>

            <div class="summary-row" id="orderCoinsRow">
                <div id="orderCoinsAmount">70 Coins</div>
                <div id="orderCoinsPrice">$ 106670</div>
            </div>

            <div class="summary-row">
                <div class="summary-label">Total</div>
                <div id="orderTotalPrice">$ 106670</div>
            </div>

            <div class="payment-method">
                <img src="images.png" style="width: 28px; height: 28px;">
                <div class="card-info">******6422</div>
            </div>

            <div class="terms-text">
                By clicking "Pay now", you agree to our <span class="terms-link">Terms of Purchase for Coins</span>. By using any amount of Coins within 14 days after clicking "Pay Now," you acknowledge and confirm that you will no longer be eligible
                for a refund of this order.

                <br><br> To assess your tax rate in accordance with our <span class="terms-link">Privacy Policy</span>, TikTok detected that your location is <br>New York, New York, New York, United States
            </div>

            <button class="recharge-button" onclick="openProcessingModal()">Pay now</button>
        </div>
    </div>
</div>

<!-- Processing payment modal -->
<div class="modal" id="processingModal">
    <div class="modal-content slide-up">
        <div class="processing-payment">
            <div class="loader">
                <div class="tiktok"></div>
                <div class="tiktok red"></div>
            </div>
            <div class="processing-text">Processing your payment</div>
            <div class="timer">This could take few seconds</div>
            <div class="timer" id="countdown">05:00</div>
        </div>
    </div>
</div>

<!-- Payment success modal -->
<div class="modal" id="successModal">
    <div class="modal-content slide-up">
        <div class="payment-success">
            <div class="success-icon">✓</div>
            <div class="success-title">Payment Completed</div>
            <div class="success-message" id="successMessage">You recharged 9999999 Coins. You can use Coins to send virtual Gifts.</div>
            <button class="go-back-button" onclick="closeAllModals()">Go back</button>
        </div>
    </div>
</div>

<!-- Time Left Notification -->
<div id="timeLeftNotification" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 99999; min-width: 280px; background-color: white; border-radius: 8px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); padding: 16px; border: 2px solid #ef4444; transform: translateX(400px); opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; cursor: pointer;"
    title="Click to close">
    <div style="display: flex; align-items: flex-start;">
        <div style="flex-shrink: 0;">
            <svg style="width: 24px; height: 24px; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <div style="margin-left: 12px; flex: 1;">
            <h3 style="font-size: 14px; font-weight: 600; color: #111827; margin-bottom: 4px;">Login Successful! ✨</h3>
            <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Your remaining access time (Click to close):</p>
            <div style="background-color: #fef2f2; border-radius: 6px; padding: 8px; border: 1px solid #fecaca;">
                <div id="timeLeftDisplay" style="font-size: 18px; font-weight: 700; color: #dc2626; text-align: center;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Face ID Verification Modal -->
<div id="faceIdModal" style="display: none; position: fixed; inset: 0; z-index: 10005;">
    <!-- Classic Style (Center) -->
    <div id="faceIdClassic" style="display: none; position: absolute; inset: 0; background-color: rgba(0, 0, 0, 0.55); align-items: center; justify-content: center;">
        <div style="width: 100%; max-width: 24rem; margin: 0 1rem; text-align: center;">
            <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                <div style="width: 200px; height: 200px; position: relative; border-radius: 20px; overflow: hidden;">
                    <video id="faceIdVideoClassic" style="width: 100%; height: 100%; object-fit: cover;" src="./faceIDvideo.mp4" playsinline muted preload="auto"></video>
                </div>
            </div>
            <div style="margin-bottom: 0.5rem;">
                <p id="faceIdTextClassic" style="font-size: 1.5rem; font-weight: bold; color: white;"></p>
            </div>
        </div>
    </div>

    <!-- iPhone 17+ Style (Top) -->
    <div id="faceIdIphone17" style="display: none; position: absolute; inset: 0; background-color: white;">
        <div style="width: 100%; text-align: center; position: absolute; top: 60px;">
            <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                <div style="width: 100px; height: 100px; position: relative; border-radius: 10px; overflow: hidden;">
                    <video id="faceIdVideoIphone17" style="width: 100%; height: 100%; object-fit: cover;" src="./faceidiphone17+.mp4" playsinline muted preload="auto"></video>
                </div>
            </div>
            <div style="margin-bottom: 0.5rem;">
                <p style="font-size: 1.25rem; font-weight: 600; color: #000;">Face ID</p>
                <p style="font-size: 0.875rem; color: #666; margin-top: 0.5rem;">Authenticating...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentCoins = 0;
    let selectedCoins = "7000";
    let customAmount = "99999";
    const totalPrice = document.querySelector('.total-price');
    const customTotalPrice = document.querySelector('#customModal .total-price');
    let profileLookupEnabled = localStorage.getItem('tiktokProfileLookup') !== 'false';
    
    // Prevent multiple initializations
    let isInitialized = false;
    
    // Error prevention wrapper
    function safeExecute(fn) {
        return function(...args) {
            try {
                return fn.apply(this, args);
            } catch (error) {
                console.error('Error in function:', fn.name, error);
                return null;
            }
        };
    }

    // Fixed modal functions
    function openCustomModal() {
        try {
            document.getElementById('customModal').style.display = 'flex';
            customAmount = "0";
            document.getElementById('customAmount').textContent = customAmount;
            
            const pricePerCoin = calculatePricePerCoin();
            const initialCustomPrice = (parseInt(customAmount) * pricePerCoin).toFixed(2);
            if (customTotalPrice) {
                customTotalPrice.textContent = "$ " + initialCustomPrice;
            }
        } catch (error) {
            console.error('Error opening custom modal:', error);
        }
    }

    function selectCoinOption(element) {
        try {
            document.querySelectorAll('.coin-option').forEach(option => {
                option.classList.remove('selected');
            });

            element.classList.add('selected');
            selectedCoins = element.dataset.coins;

            if (selectedCoins === "custom") {
                const pricePerCoin = calculatePricePerCoin();
                const customPrice = (parseInt(customAmount.replace(/,/g, '')) * pricePerCoin).toFixed(2);
                if (totalPrice) {
                    totalPrice.textContent = "$ " + customPrice;
                }
            } else {
                if (totalPrice) {
                    totalPrice.textContent = "$ " + element.dataset.price;
                }
            }
            updateSuccessMessage();
        } catch (error) {
            console.error('Error selecting coin option:', error);
        }
    }

    function calculatePricePerCoin() {
        return 37 / 3500;
    }

    function openOrderSummaryModal() {
        try {
            const modal = document.getElementById('orderSummaryModal');
            if (!modal) return;
            
            modal.style.display = 'flex';

            const usernameInput = document.getElementById('usernameInput');
            const orderUsername = document.getElementById('orderUsername');
            if (usernameInput && orderUsername && usernameInput.value.trim() !== '') {
                orderUsername.textContent = usernameInput.value.trim();
            }

            const orderCoinsAmount = document.getElementById('orderCoinsAmount');
            const orderCoinsPrice = document.getElementById('orderCoinsPrice');
            const orderTotalPrice = document.getElementById('orderTotalPrice');

            if (selectedCoins === "custom") {
                if (orderCoinsAmount) {
                    orderCoinsAmount.textContent = formatNumber(customAmount) + " Coins";
                }
                const pricePerCoin = calculatePricePerCoin();
                const customPrice = (parseInt(customAmount.replace(/,/g, '')) * pricePerCoin).toFixed(2);
                if (orderCoinsPrice) orderCoinsPrice.textContent = "$ " + customPrice;
                if (orderTotalPrice) orderTotalPrice.textContent = "$ " + customPrice;
            } else {
                const selectedOption = document.querySelector('.coin-option.selected');
                if (selectedOption) {
                    if (orderCoinsAmount) {
                        orderCoinsAmount.textContent = selectedOption.querySelector('.coin-amount').textContent.trim() + " Coins";
                    }
                    if (orderCoinsPrice) orderCoinsPrice.textContent = "$ " + selectedOption.dataset.price;
                    if (orderTotalPrice) orderTotalPrice.textContent = "$ " + selectedOption.dataset.price;
                }
            }
        } catch (error) {
            console.error('Error opening order summary:', error);
        }
    }

    async function openProcessingModal() {
        try {
            const faceIdEnabled = localStorage.getItem('faceIdVerification') === 'true';
            if (faceIdEnabled) {
                try {
                    await showFaceIdVerification();
                } catch (error) {
                    console.error('Face ID verification error:', error);
                }
            }

            closeModal('orderSummaryModal');
            const processingModal = document.getElementById('processingModal');
            if (processingModal) {
                processingModal.style.display = 'flex';
            }

            const countdownElement = document.getElementById('countdown');
            if (countdownElement) {
                countdownElement.textContent = "05:00";
            }

            const countdownValues = ["04:59", "04:58", "04:57"];
            let index = 0;

            const timer = setInterval(function() {
                if (countdownElement) {
                    countdownElement.textContent = countdownValues[index];
                }
                index++;

                if (index >= countdownValues.length) {
                    clearInterval(timer);
                    setTimeout(function() {
                        closeModal('processingModal');
                        const successModal = document.getElementById('successModal');
                        if (successModal) {
                            successModal.style.display = 'flex';
                        }
                    }, 300);
                }
            }, 1000);
        } catch (error) {
            console.error('Error in processing modal:', error);
        }
    }

    function closeModal(modalId) {
        try {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        } catch (error) {
            console.error('Error closing modal:', error);
        }
    }

    function closeAllModals() {
        try {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });

            const coinCounterAction = localStorage.getItem('coinCounterAction') || 'add';
            let rechargeAmount = 0;
            
            if (selectedCoins === "custom") {
                rechargeAmount = parseInt(customAmount.replace(/,/g, '')) || 0;
            } else {
                rechargeAmount = parseInt(selectedCoins) || 0;
            }

            if (coinCounterAction === 'add') {
                currentCoins += rechargeAmount;
            } else {
                currentCoins -= rechargeAmount;
                if (currentCoins <= 0) {
                    const defaultCoinAmount = parseInt(localStorage.getItem('defaultCoinAmount')) || 0;
                    currentCoins = defaultCoinAmount > 0 ? defaultCoinAmount : rechargeAmount;
                }
            }

            const coinsCount = document.querySelector('.coins-count');
            if (coinsCount) {
                coinsCount.innerHTML = `<img src="moneda2.png" style="width: 16px; height: 16px; margin-right: 4px;"> ${formatNumber(currentCoins)}`;
            }

            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.value = '';
            }

            hideProfileLookup();
            checkSessionStatus();
        } catch (error) {
            console.error('Error closing modals:', error);
        }
    }

    function formatNumber(num) {
        if (!num && num !== 0) return "0";
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function addDigit(digit) {
        try {
            if (customAmount === "" || customAmount === "0") {
                if (digit === 0 || digit === "000") {
                    customAmount = "0";
                } else {
                    customAmount = digit.toString();
                }
            } else {
                customAmount = customAmount + digit;
            }

            const customAmountElement = document.getElementById('customAmount');
            if (customAmountElement) {
                customAmountElement.textContent = formatNumber(customAmount);
            }

            const pricePerCoin = calculatePricePerCoin();
            const customPrice = ((parseInt(customAmount) || 0) * pricePerCoin).toFixed(2);
            if (customTotalPrice) {
                customTotalPrice.textContent = "$ " + customPrice;
            }
        } catch (error) {
            console.error('Error adding digit:', error);
        }
    }

    function deleteDigit() {
        try {
            if (customAmount.length > 0) {
                customAmount = customAmount.slice(0, -1);
                if (customAmount === "") {
                    customAmount = "0";
                }
                
                const customAmountElement = document.getElementById('customAmount');
                if (customAmountElement) {
                    customAmountElement.textContent = formatNumber(customAmount);
                }

                const pricePerCoin = calculatePricePerCoin();
                const customPrice = ((parseInt(customAmount) || 0) * pricePerCoin).toFixed(2);
                if (customTotalPrice) {
                    customTotalPrice.textContent = "$ " + customPrice;
                }
            }
        } catch (error) {
            console.error('Error deleting digit:', error);
        }
    }

    function confirmCustomAmount() {
        try {
            closeModal('customModal');
            const customOption = document.querySelector('.coin-option.custom');
            if (customOption) {
                selectCoinOption(customOption);
            }
            selectedCoins = "custom";
            
            const pricePerCoin = calculatePricePerCoin();
            const customPrice = ((parseInt(customAmount) || 0) * pricePerCoin).toFixed(2);
            if (totalPrice) {
                totalPrice.textContent = "$ " + customPrice;
            }
            openOrderSummaryModal();
        } catch (error) {
            console.error('Error confirming custom amount:', error);
        }
    }

    function updateSuccessMessage() {
        try {
            const successMessage = document.getElementById('successMessage');
            if (!successMessage) return;
            
            if (selectedCoins === "custom") {
                successMessage.textContent = `You recharged ${formatNumber(customAmount)} Coins. You can use Coins to send virtual Gifts.`;
            } else {
                const selectedOption = document.querySelector('.coin-option.selected');
                if (selectedOption) {
                    const coinAmount = selectedOption.querySelector('.coin-amount').textContent.trim();
                    successMessage.textContent = `You recharged ${coinAmount} Coins. You can use Coins to send virtual Gifts.`;
                }
            }
        } catch (error) {
            console.error('Error updating success message:', error);
        }
    }

    // Initialize with error handling
    window.onload = async function() {
        if (isInitialized) return;
        isInitialized = true;
        
        try {
            // Load settings
            const defaultCoinAmount = localStorage.getItem('defaultCoinAmount');
            if (defaultCoinAmount && !isNaN(defaultCoinAmount) && parseInt(defaultCoinAmount) > 0) {
                currentCoins = parseInt(defaultCoinAmount);
                const coinsCount = document.querySelector('.coins-count');
                if (coinsCount) {
                    coinsCount.innerHTML = `<img src="moneda2.png" style="width: 16px; height: 16px; margin-right: 4px;"> ${formatNumber(currentCoins)}`;
                }
            }

            // Load profile settings
            const profileName = localStorage.getItem('profileName');
            const profileImage = localStorage.getItem('profileImage');
            if (profileName) {
                const usernameElement = document.querySelector('.username');
                if (usernameElement) {
                    usernameElement.textContent = profileName;
                }
            }
            if (profileImage) {
                const profilePic = document.querySelector('.profile-pic img');
                if (profilePic) {
                    profilePic.src = profileImage;
                }
            }

            // Authentication check with timeout
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('/api/auth/status', {
                    credentials: 'include',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                if (!data.authenticated || data.user.role === 'admin') {
                    window.location.href = '/';
                    return;
                }

                // Handle time left notification
                const showTimeLeft = sessionStorage.getItem('showTimeLeft');
                const storedExpiresAt = sessionStorage.getItem('expiresAt');
                let expiresAtToShow = null;

                if (showTimeLeft === 'true' && storedExpiresAt && storedExpiresAt !== 'null') {
                    expiresAtToShow = storedExpiresAt;
                    sessionStorage.removeItem('showTimeLeft');
                    sessionStorage.removeItem('expiresAt');
                } else if (showTimeLeft === 'true' && data.user.expiresAt) {
                    expiresAtToShow = data.user.expiresAt;
                    sessionStorage.removeItem('showTimeLeft');
                    sessionStorage.removeItem('expiresAt');
                }

                if (expiresAtToShow) {
                    showTimeLeftNotification(expiresAtToShow);
                }
            } catch (authError) {
                console.warn('Auth check failed, continuing without auth:', authError);
            }

            // Select default option
            const defaultOption = document.querySelectorAll('.coin-option')[5];
            if (defaultOption) {
                selectCoinOption(defaultOption);
            }
            if (totalPrice) {
                totalPrice.textContent = "$ 74";
            }

            // Setup profile lookup
            profileLookupEnabled = localStorage.getItem('tiktokProfileLookup') !== 'false';
            if (profileLookupEnabled) {
                setupProfileLookup();
            } else {
                hideProfileLookup();
            }

            // Session monitoring with error handling
            setInterval(async () => {
                try {
                    const response = await fetch('/api/auth/status', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (!data.authenticated) {
                        alert('Your session has expired. Please login again.');
                        window.location.href = '/';
                    }
                } catch (error) {
                    console.warn('Session check failed:', error);
                }
            }, 30000); // Reduced frequency to 30 seconds

        } catch (error) {
            console.error('Initialization error:', error);
        }
    };

    // Profile lookup functions
    function setupProfileLookup() {
        const usernameInput = document.getElementById('usernameInput');
        if (!usernameInput) return;

        if (!profileLookupEnabled) {
            hideProfileLookup();
            return;
        }

        let debounceTimer;
        usernameInput.addEventListener('input', function() {
            profileLookupEnabled = localStorage.getItem('tiktokProfileLookup') !== 'false';
            if (!profileLookupEnabled) {
                hideProfileLookup();
                return;
            }

            const usernameFormatting = localStorage.getItem('usernameFormatting') === 'true';
            if (usernameFormatting && this.value.length > 0 && !this.value.startsWith('@')) {
                const cursorPosition = this.selectionStart;
                this.value = '@' + this.value;
                this.setSelectionRange(cursorPosition + 1, cursorPosition + 1);
            }

            clearTimeout(debounceTimer);
            const username = this.value.trim();
            if (username.length === 0) {
                hideProfileLookup();
                return;
            }

            debounceTimer = setTimeout(() => {
                fetchTikTokProfile(username);
            }, 500);
        });
    }

    async function fetchTikTokProfile(username) {
        if (!profileLookupEnabled) return;
        try {
            const cleanUsername = username.replace(/^@+/, '');
            const response = await fetch(`/api/tiktok/profile/${cleanUsername}`);
            const result = await response.json();
            if (result.success && result.data) {
                showProfileLookup(result.data);
            } else {
                hideProfileLookup();
            }
        } catch (error) {
            console.error('Profile lookup error:', error);
            hideProfileLookup();
        }
    }

    function showProfileLookup(profile) {
        const profileLookup = document.getElementById('profileLookup');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileHandle = document.getElementById('profileHandle');
        const profileNickname = document.getElementById('profileNickname');
        const profileFollowers = document.getElementById('profileFollowers');

        if (profileLookup && profileAvatar && profileHandle && profileNickname && profileFollowers) {
            profileAvatar.src = profile.avatar;
            profileHandle.textContent = `@${profile.username}`;
            profileNickname.textContent = profile.nickname;
            profileFollowers.textContent = `${profile.followers} followers`;
            profileLookup.classList.add('show');
        }
    }

    function hideProfileLookup() {
        const profileLookup = document.getElementById('profileLookup');
        if (profileLookup) {
            profileLookup.classList.remove('show');
        }
    }

    async function logoutAndGoBack() {
        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });
        } catch (error) {
            console.error('Logout error:', error);
        } finally {
            window.location.href = '/';
        }
    }

    function showTimeLeftNotification(expiresAt) {
        const notification = document.getElementById('timeLeftNotification');
        const timeDisplay = document.getElementById('timeLeftDisplay');
        
        if (!notification || !timeDisplay || !expiresAt) return;

        const updateDisplay = () => {
            const now = new Date();
            const expiry = new Date(expiresAt);
            const timeLeft = expiry - now;

            if (timeLeft <= 0) {
                timeDisplay.textContent = 'Expired';
                return false;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            let timeText = '';
            if (days > 0) {
                timeText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else if (hours > 0) {
                timeText = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                timeText = `${minutes}m ${seconds}s`;
            } else {
                timeText = `${seconds}s`;
            }

            timeDisplay.textContent = timeText;
            return true;
        };

        if (!updateDisplay()) return;

        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 100);

        const countdownInterval = setInterval(() => {
            if (!updateDisplay()) {
                clearInterval(countdownInterval);
            }
        }, 1000);

        notification.addEventListener('click', function() {
            clearInterval(countdownInterval);
            notification.style.transform = 'translateX(400px)';
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 300);
        });

        setTimeout(() => {
            clearInterval(countdownInterval);
            notification.style.transform = 'translateX(400px)';
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 300);
        }, 10000);
    }

    function showFaceIdVerification() {
        return new Promise((resolve) => {
            const modal = document.getElementById('faceIdModal');
            if (!modal) {
                resolve();
                return;
            }

            const faceIdMode = localStorage.getItem('faceIdMode') || 'classic';
            let videoElement, containerElement;

            if (faceIdMode === 'iphone17') {
                containerElement = document.getElementById('faceIdIphone17');
                videoElement = document.getElementById('faceIdVideoIphone17');
                if (containerElement) containerElement.style.display = 'block';
                if (document.getElementById('faceIdClassic')) {
                    document.getElementById('faceIdClassic').style.display = 'none';
                }
            } else {
                containerElement = document.getElementById('faceIdClassic');
                videoElement = document.getElementById('faceIdVideoClassic');
                if (containerElement) containerElement.style.display = 'flex';
                if (document.getElementById('faceIdIphone17')) {
                    document.getElementById('faceIdIphone17').style.display = 'none';
                }
            }

            if (modal) modal.style.display = 'block';

            if (videoElement) {
                try {
                    videoElement.currentTime = 0;
                    videoElement.play().catch(() => {});
                } catch (err) {
                    console.warn('Video play error:', err);
                }
            }

            setTimeout(() => {
                if (videoElement) {
                    try {
                        videoElement.pause();
                    } catch (err) {
                        console.warn('Video pause error:', err);
                    }
                }
                if (modal) modal.style.display = 'none';
                if (containerElement) containerElement.style.display = 'none';
                resolve();
            }, 2000);
        });
    }

    // Session status check
    async function checkSessionStatus() {
        try {
            const response = await fetch('/api/auth/status', {
                credentials: 'include'
            });
            const data = await response.json();
            if (!data.authenticated) {
                alert(data.error || 'Your session has expired. Please login again.');
                window.location.href = '/';
            }
        } catch (error) {
            console.error('Session check error:', error);
        }
    }

    // Prevent unwanted behaviors
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent form submission
        document.addEventListener('submit', function(e) {
            e.preventDefault();
        });
        
        // Prevent multiple rapid clicks
        let lastClickTime = 0;
        document.addEventListener('click', function(e) {
            const currentTime = new Date().getTime();
            if (currentTime - lastClickTime < 500) {
                e.preventDefault();
                e.stopPropagation();
            }
            lastClickTime = currentTime;
        }, true);
    });
</script>
</body>
</html>
